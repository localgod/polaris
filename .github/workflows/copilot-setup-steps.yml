name: Copilot Setup Steps

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  setup-and-cache:
    name: Setup Node and cache dependencies
    runs-on: ubuntu-latest
    outputs:
      node-version: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20 (LTS)
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --unsafe-perm

      - name: Verify basic repo files
        run: |
          echo "Found package.json:"
          test -f package.json && cat package.json | jq -r '.name,.version' || true

  lint-and-mdlint:
    name: Lint (ESLint) and Markdown Lint
    runs-on: ubuntu-latest
    needs: setup-and-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --unsafe-perm

      - name: Run markdownlint
        run: npm run mdlint

      - name: Run ESLint
        run: npm run lint

  migrate-validate:
    name: Validate migrations
    runs-on: ubuntu-latest
    needs: setup-and-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --unsafe-perm

      - name: Validate migrations
        run: npm run migrate:validate

  tests:
    name: Run tests (Vitest) with Neo4j service
    runs-on: ubuntu-latest
    needs: [setup-and-cache, migrate-validate]
    services:
      neo4j:
        image: neo4j:5.8
        ports:
          - 7474:7474
          - 7687:7687
        env:
          NEO4J_AUTH: neo4j/testpassword
    env:
      NEO4J_URI: bolt://localhost:7687
      NEO4J_USERNAME: neo4j
      NEO4J_PASSWORD: testpassword

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 20
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci --unsafe-perm

      - name: Wait for Neo4j to be available
        run: |
          echo "Waiting for Neo4j to accept connections on 7687..."
          for i in {1..60}; do
            nc -z localhost 7687 && echo "Neo4j is up" && break || echo "waiting... ($i)" && sleep 2
          done

      - name: Run tests (CI mode)
        run: npm run test:ci

  suggested-pr-checks:
    name: Suggested Copilot/PR checks
    runs-on: ubuntu-latest
    needs: [lint-and-mdlint, tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Use Node.js 18
        uses: actions/setup-node@v6
        with:
          node-version: 18

      - name: "Quick smoke: build"
        run: npm run build

      - name: Generate OpenAPI (optional)
        if: always()
        run: |
          # Regenerate OpenAPI spec for review (safe, read-only)
          npm run docs:api || echo "docs:api failed or skipped"

      - name: Post-check summary
        run: |
          echo "Lint and tests completed. If this is a Copilot suggestion PR, ensure the following in the PR description:" 
          echo "- What was changed and why (2-3 lines)"
          echo "- Any migration files added (include up/down)"
          echo "- Tests added/updated and passing"
          echo "- Any devcontainer or environment changes"

tasks:
  # Install dependencies
  install-deps:
    name: Install Dependencies
    command: |
      echo "üì¶ Installing dependencies..."
      npm install
      echo "‚úÖ Dependencies installed"
    triggeredBy:
      - postEnvironmentStart
    
  # Wait for Neo4j to be ready
  wait-neo4j:
    name: Wait for Neo4j
    command: |
      echo "‚è≥ Waiting for Neo4j to be ready..."
      max_attempts=60
      attempt=0
      
      while [ $attempt -lt $max_attempts ]; do
        if curl -s http://localhost:7474 > /dev/null 2>&1; then
          echo "‚úÖ Neo4j is ready!"
          exit 0
        fi
        attempt=$((attempt + 1))
        echo "Attempt $attempt/$max_attempts - Neo4j not ready yet..."
        sleep 2
      done
      
      echo "‚ùå Neo4j failed to start within timeout"
      exit 1
    triggeredBy:
      - postEnvironmentStart
    
  # Run database migrations
  run-migrations:
    name: Run Database Migrations
    command: |
      echo "‚è≥ Waiting for dependencies..."
      while [ ! -d "node_modules" ]; do
        sleep 1
      done
      
      echo "‚è≥ Waiting for Neo4j..."
      max_attempts=60
      attempt=0
      while [ $attempt -lt $max_attempts ]; do
        if curl -s http://localhost:7474 > /dev/null 2>&1; then
          break
        fi
        attempt=$((attempt + 1))
        sleep 2
      done
      
      echo "üîÑ Running database migrations..."
      npm run migrate:up
      echo "‚úÖ Migrations completed"
    triggeredBy:
      - postEnvironmentStart

services:
  # Nuxt development server with hot reload
  nuxt-dev:
    name: Nuxt Dev Server
    description: Nuxt development server with hot module replacement
    commands:
      start: |
        echo "‚è≥ Waiting for dependencies..."
        while [ ! -d "node_modules" ]; do
          sleep 1
        done
        
        echo "üöÄ Starting Nuxt development server..."
        npm run dev
      ready: |
        if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "‚úÖ Nuxt dev server is ready"
          exit 0
        else
          echo "‚è≥ Nuxt dev server is not ready yet"
          exit 1
        fi
    triggeredBy:
      - postEnvironmentStart

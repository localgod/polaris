tasks:
  # Install dependencies
  # Runs automatically on environment start
  # Can also be triggered manually: gitpod automations task start install-deps
  install-deps:
    name: Install Dependencies
    command: |
      echo "üì¶ Installing dependencies..."
      npm install
      echo "‚úÖ Dependencies installed"
    triggeredBy:
      - postDevcontainerStart
    
  # Wait for Neo4j to be ready
  # Runs automatically on environment start
  # Can also be triggered manually: gitpod automations task start wait-neo4j
  wait-neo4j:
    name: Wait for Neo4j
    command: |
      echo "‚è≥ Waiting for Neo4j to be ready..."
      
      # Source .env for connection details
      set -a
      source .env
      set +a
      
      max_attempts=30
      attempt=0
      
      # Detect local vs hosted instance
      if echo "$NEO4J_URI" | grep -q "localhost"; then
        echo "Using local Neo4j instance..."
        while [ $attempt -lt $max_attempts ]; do
          if curl -s http://localhost:7474 > /dev/null 2>&1; then
            echo "‚úÖ Neo4j is ready!"
            exit 0
          fi
          attempt=$((attempt + 1))
          echo "Attempt $attempt/$max_attempts - Neo4j not ready yet..."
          sleep 2
        done
      else
        echo "Using hosted Neo4j instance at $NEO4J_URI..."
        # For hosted instances, wait for node_modules then use cypher-shell or a quick connection test
        while [ ! -d "node_modules" ]; do
          sleep 1
        done
        while [ $attempt -lt $max_attempts ]; do
          if npx --yes neo4j-driver-bolt-connection 2>/dev/null || node -e "
            const neo4j = require('neo4j-driver');
            const d = neo4j.driver('$NEO4J_URI', neo4j.auth.basic('$NEO4J_USERNAME', '$NEO4J_PASSWORD'));
            d.verifyAuthentication().then(() => { console.log('ok'); d.close(); process.exit(0); }).catch(() => { d.close(); process.exit(1); });
          " 2>/dev/null; then
            echo "‚úÖ Neo4j is ready!"
            exit 0
          fi
          attempt=$((attempt + 1))
          echo "Attempt $attempt/$max_attempts - Neo4j not reachable yet..."
          sleep 2
        done
      fi
      
      echo "‚ùå Neo4j failed to become ready within timeout"
      exit 1
    triggeredBy:
      - postEnvironmentStart
    
  # Run database migrations
  # Runs automatically on environment start
  # Can also be triggered manually: gitpod automations task start run-migrations
  run-migrations:
    name: Run Database Migrations
    command: |
      echo "‚è≥ Waiting for dependencies..."
      while [ ! -d "node_modules" ]; do
        sleep 1
      done
      
      # Source .env for connection details
      set -a
      source .env
      set +a
      
      echo "‚è≥ Waiting for Neo4j..."
      max_attempts=30
      attempt=0
      if echo "$NEO4J_URI" | grep -q "localhost"; then
        while [ $attempt -lt $max_attempts ]; do
          if curl -s http://localhost:7474 > /dev/null 2>&1; then
            break
          fi
          attempt=$((attempt + 1))
          sleep 2
        done
      else
        # For hosted instances, verify connectivity via driver
        while [ $attempt -lt $max_attempts ]; do
          if node -e "
            const neo4j = require('neo4j-driver');
            const d = neo4j.driver('$NEO4J_URI', neo4j.auth.basic('$NEO4J_USERNAME', '$NEO4J_PASSWORD'));
            d.verifyAuthentication().then(() => { d.close(); process.exit(0); }).catch(() => { d.close(); process.exit(1); });
          " 2>/dev/null; then
            break
          fi
          attempt=$((attempt + 1))
          echo "Attempt $attempt/$max_attempts - Neo4j not reachable yet..."
          sleep 2
        done
      fi
      
      echo "üîÑ Running database migrations..."
      npm run migrate:up
      echo "‚úÖ Migrations completed"
    triggeredBy:
      - postEnvironmentStart
  
  # Check migration status (on-demand only)
  # Run manually: gitpod automations task start migration-status
  migration-status:
    name: Check Migration Status
    command: |
      echo "üìä Checking migration status..."
      npm run migrate:status
  
  # Validate migrations (on-demand only)
  # Run manually: gitpod automations task start validate-migrations
  validate-migrations:
    name: Validate Migrations
    command: |
      echo "üîç Validating migrations..."
      npm run migrate:validate
  
  # Seed database with fixture data (on-demand only)
  # Run manually: gitpod automations task start seed-database
  seed-database:
    name: Seed Database with Fixtures
    command: |
      echo "üå± Seeding database with fixture data..."
      npm run seed
      echo "‚úÖ Database seeded successfully"
  
  # Reset database to known state (on-demand only)
  # Run manually: gitpod automations task start reset-database
  reset-database:
    name: Reset Database to Known State
    command: |
      echo "üîÑ Resetting database to known state..."
      echo "‚ö†Ô∏è  This will clear all non-migration data!"
      npm run seed:clear
      echo "‚úÖ Database reset complete"

services:
  # Nuxt development server with hot reload
  nuxt-dev:
    name: Nuxt Dev Server
    description: Nuxt development server with hot module replacement
    commands:
      start: |
        echo "‚è≥ Waiting for dependencies..."
        while [ ! -d "node_modules" ]; do
          sleep 1
        done
        
        echo "üöÄ Starting Nuxt development server..."
        npm run dev
      ready: |
        if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "‚úÖ Nuxt dev server is ready"
          exit 0
        else
          echo "‚è≥ Nuxt dev server is not ready yet"
          exit 1
        fi
    triggeredBy:
      - postEnvironmentStart
